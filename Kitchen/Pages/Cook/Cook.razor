@page "/cook"
@using Kitchen.Backend.Models
@using Kitchen.Backend.Services

@inject RecipeService RecipeService
@inject IDialogService DialogService

<MudContainer>
    <MudGrid>
        <MudItem xs="3">
            <MudList Clickable="true">
                @foreach (var item in _recipes)
                {
                    <MudListItem @onclick="() => SelectItem(item)">
                        @item.Name
                    </MudListItem>
                }
            </MudList>
            <MudTextField @bind-Value="NewRecipe" Label="Standard" Variant="Variant.Text" Class=@(Editable ? "" : "invisible")></MudTextField>
            <MudButton Variant="Variant.Filled" OnClick="AddRecipe" Class=@(Editable ? "" : "invisible")>Add recipe</MudButton>
        </MudItem>
        <MudItem xs="9">
            @if (_selectedRecipe != null)
            {
                <MudCard>
                    <MudCardMedia Image="@_selectedRecipe.ImageUrl" Title="@_selectedRecipe.Name"/>
                    <MudCardContent>
                        @foreach (var instruction in _selectedRecipe.Instructions)
                        {
                            <MudList Clickable="Editable">
                                <MudListItem @onclick="() => OpenInstructionDialog(instruction.Id, instruction.Description, instruction.Number)">  
                                    @instruction.Number @instruction.Description
                                </MudListItem>
                            </MudList>
                        }
                        <MudContainer Class="d-flex" Style="gap: 10px; align-items: center;">
                            <MudFileUpload T="IBrowserFile" FilesChanged="UploadImage" Class=@(Editable ? "" : "invisible")>
                                <ButtonTemplate>
                                    <MudFab HtmlTag="label"
                                            Color="Color.Dark"
                                            Icon="@Icons.Material.Filled.Image"
                                            Label="Load picture"
                                            for="@context.Id"/>
                                </ButtonTemplate>
                            </MudFileUpload>
                            <MudIconButton Icon="@Icons.Material.Filled.Add" aria-label="add"
                                           OnClick="AddInstruction" Class=@(Editable ? "" : "invisible")></MudIconButton>
                            <MudIconButton Icon="@Icons.Material.Filled.Save" aria-label="save"
                                           OnClick="SaveInstructions" Class=@(Editable ? "" : "invisible")></MudIconButton>
                            <MudIconButton Icon="@Icons.Material.Filled.DeleteForever" aria-label="save"
                                           OnClick="DeleteRecipe" Class=@(Editable ? "" : "invisible")></MudIconButton>
                        </MudContainer>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<Recipe> _recipes;
    private Recipe _selectedRecipe;
    public string NewRecipe { get; set; }

    [CascadingParameter]
    public bool Editable { get; set; }

    protected override void OnInitialized()
    {
        // Initialize the list of items with some data
        _recipes = RecipeService.GetRecipes();

        // Set the initial selected item
        _selectedRecipe = _recipes.FirstOrDefault();
    }

    private void SelectItem(Recipe recipe)
    {
        _selectedRecipe = recipe;
    }

    private void AddRecipe()
    {
        RecipeService.AddRecipe(NewRecipe);
        StateHasChanged();
    }

    private void AddInstruction()
    {
        var instruction = new Instruction
        {
            Description = "",
            Number = _selectedRecipe.Instructions.Count + 1
        };

        RecipeService.AddInstruction(_selectedRecipe.Id, instruction);
        StateHasChanged();
    }

    private void DeleteInstruction(Instruction instruction)
    {
        RecipeService.DeleteInstruction(_selectedRecipe.Id, instruction);
        StateHasChanged();
    }

    private async Task UploadImage(IBrowserFile file)
    {
        await RecipeService.AddImage(_selectedRecipe.Id, file);
        StateHasChanged();
    }

    private void SaveInstructions()
    {

    }

    private void UpdateInstruction()
    {

    }

    private async Task OpenInstructionDialog(long instructionId, string oldDescription, int oldNumber)
    {
        if (!Editable)
        {
            return;
        }

        var parameters = new DialogParameters<InstructionDialog>
        {
            { x => x.OldInstruction, oldDescription},
            { x => x.OldNumber, oldNumber},
        };
        var options = new DialogOptions { CloseOnEscapeKey = true };

        var dialog = await DialogService.ShowAsync<InstructionDialog>("Update instruction", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
        {
            return;
        }

        RecipeService.SaveInstruction(_selectedRecipe.Id, instructionId, (Instruction)result.Data);
        StateHasChanged();
    }

    private void DeleteRecipe()
    {
        RecipeService.DeleteRecipe(_selectedRecipe.Id);
        StateHasChanged();
    }
}